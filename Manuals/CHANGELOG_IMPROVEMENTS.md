# Changelog: –£–ª—É—á—à–µ–Ω–∏—è –∏ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥

## –î–∞—Ç–∞: 6 —è–Ω–≤–∞—Ä—è 2026

### 36. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω –∫–æ–Ω—Ñ–ª–∏–∫—Ç –º–∏–≥—Ä–∞—Ü–∏–π Alembic

**–§–∞–π–ª—ã:**
- `alembic/versions/20260106_add_payments_table.py` ‚Äî –∏—Å–ø—Ä–∞–≤–ª–µ–Ω `down_revision`
- `Manuals/FIX_ALEMBIC_CONFLICT.md` ‚Äî –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—é

**–ü—Ä–æ–±–ª–µ–º–∞:** –û—à–∏–±–∫–∞ `Multiple head revisions are present for given argument 'head'`

–ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –º–∏–≥—Ä–∞—Ü–∏–∏ –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã `payments` –±—ã–ª —É–∫–∞–∑–∞–Ω `down_revision = None`, —á—Ç–æ —Å–æ–∑–¥–∞–ª–æ –Ω–æ–≤—É—é –≤–µ—Ç–∫—É –º–∏–≥—Ä–∞—Ü–∏–π –≤–º–µ—Å—Ç–æ –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π —Ü–µ–ø–æ—á–∫–∏.

**–†–µ—à–µ–Ω–∏–µ:** –ò–∑–º–µ–Ω—ë–Ω `down_revision` –Ω–∞ `'extend_source_url'`, —á—Ç–æ–±—ã –º–∏–≥—Ä–∞—Ü–∏—è —à–ª–∞ –ø–æ—Å–ª–µ –ø—Ä–µ–¥—ã–¥—É—â–µ–π.

```python
# –ë—ã–ª–æ:
down_revision: Union[str, None] = None

# –°—Ç–∞–ª–æ:
down_revision: Union[str, None] = 'extend_source_url'
```

**–ö–∞–∫ –∏—Å–ø—Ä–∞–≤–∏—Ç—å –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ:**

–°–º. –ø–æ–¥—Ä–æ–±–Ω—É—é –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é –≤ `Manuals/FIX_ALEMBIC_CONFLICT.md`

–ö—Ä–∞—Ç–∫–∞—è –≤–µ—Ä—Å–∏—è:
```bash
# –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
docker-compose down

# –û–±–Ω–æ–≤–∏—Ç—å –∫–æ–¥
git pull

# –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–æ–ª—å–∫–æ –ë–î
docker-compose up -d db

# –û–±—ä–µ–¥–∏–Ω–∏—Ç—å –≥–æ–ª–æ–≤—ã –º–∏–≥—Ä–∞—Ü–∏–π
docker-compose run --rm app bash
alembic merge heads -m "merge payment and extend_url migrations"
alembic upgrade head
exit

# –ó–∞–ø—É—Å—Ç–∏—Ç—å –≤—Å—ë
docker-compose up -d
```

---

### 35. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –ÆKassa –¥–ª—è –ø—Ä–∏—ë–º–∞ –ø–ª–∞—Ç–µ–∂–µ–π

**–ù–æ–≤—ã–µ —Ñ–∞–π–ª—ã:**
- `bot/services/payment.py` ‚Äî —Å–µ—Ä–≤–∏—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å YooKassa API
- `bot/handlers/payment.py` ‚Äî —Ö–µ–Ω–¥–ª–µ—Ä—ã –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–ª–∞—Ç–µ–∂–µ–π
- `alembic/versions/20260106_add_payments_table.py` ‚Äî –º–∏–≥—Ä–∞—Ü–∏—è –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã payments

**–ò–∑–º–µ–Ω—ë–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:**
- `bot/config.py` ‚Äî –¥–æ–±–∞–≤–ª–µ–Ω—ã –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ YooKassa
- `bot/db/models.py` ‚Äî –¥–æ–±–∞–≤–ª–µ–Ω–∞ –º–æ–¥–µ–ª—å Payment
- `bot/db/repositories.py` ‚Äî –¥–æ–±–∞–≤–ª–µ–Ω PaymentRepository
- `bot/handlers/__init__.py` ‚Äî —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è payment_router
- `bot/handlers/menu.py` ‚Äî —É–¥–∞–ª—ë–Ω —Å—Ç–∞—Ä—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ shop
- `bot/main.py` ‚Äî –¥–æ–±–∞–≤–ª–µ–Ω webhook endpoint `/yookassa/webhook`
- `requirements.txt` ‚Äî –¥–æ–±–∞–≤–ª–µ–Ω –ø–∞–∫–µ—Ç `yookassa>=3.0.0`
- `docker-compose.yml` ‚Äî –¥–æ–±–∞–≤–ª–µ–Ω—ã –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ YooKassa
- `.env.example` ‚Äî –¥–æ–±–∞–≤–ª–µ–Ω—ã –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ YooKassa

**–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç:**

1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–±–∏—Ä–∞–µ—Ç –ø–∞–∫–µ—Ç –≤ –º–∞–≥–∞–∑–∏–Ω–µ
2. –°–æ–∑–¥–∞—ë—Ç—Å—è –ø–ª–∞—Ç—ë–∂ –≤ YooKassa
3. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –ø–æ —Å—Å—ã–ª–∫–µ –∏ –æ–ø–ª–∞—á–∏–≤–∞–µ—Ç
4. YooKassa –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç webhook –Ω–∞ `/yookassa/webhook`
5. –¢–æ–∫–µ–Ω—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞—á–∏—Å–ª—è—é—Ç—Å—è –Ω–∞ –±–∞–ª–∞–Ω—Å
6. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ –±–æ—Ç–µ
7. –ê–¥–º–∏–Ω—ã –ø–æ–ª—É—á–∞—é—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –Ω–æ–≤–æ–π –æ–ø–ª–∞—Ç–µ

**–ù–æ–≤—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è:**

| –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è | –û–ø–∏—Å–∞–Ω–∏–µ |
|------------|----------|
| `YOOKASSA_SHOP_ID` | ID –º–∞–≥–∞–∑–∏–Ω–∞ –∏–∑ –ª–∏—á–Ω–æ–≥–æ –∫–∞–±–∏–Ω–µ—Ç–∞ –ÆKassa |
| `YOOKASSA_SECRET_KEY` | –°–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–ª—é—á –∏–∑ –ª–∏—á–Ω–æ–≥–æ –∫–∞–±–∏–Ω–µ—Ç–∞ –ÆKassa |
| `YOOKASSA_RETURN_URL` | URL –≤–æ–∑–≤—Ä–∞—Ç–∞ –ø–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã (deep link –±–æ—Ç–∞) |

**–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≤ –ÆKassa:**

1. –ü–µ—Ä–µ–π—Ç–∏ –≤ –ª–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç ‚Üí –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è ‚Üí API –∫–ª—é—á–∏
2. –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å Shop ID –∏ Secret Key
3. –î–æ–±–∞–≤–∏—Ç—å –≤ `.env`
4. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å webhook: URL = `https://your-domain.com/yookassa/webhook`
5. –í—ã–±—Ä–∞—Ç—å —Å–æ–±—ã—Ç–∏—è: `payment.succeeded`, `payment.canceled`

---

## –î–∞—Ç–∞: 5 —è–Ω–≤–∞—Ä—è 2026

### 33. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω –±–∞–≥ —Å —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º —Ñ–æ—Ç–æ

**–§–∞–π–ª—ã:**
- `bot/handlers/admin.py` ‚Äî –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω `StateFilter(None)` –¥–ª—è file_id —Ö–µ–Ω–¥–ª–µ—Ä–æ–≤
- `bot/handlers/__init__.py` ‚Äî `admin_router` —É–∂–µ –±—ã–ª –≤ –∫–æ–Ω—Ü–µ —Å–ø–∏—Å–∫–∞

**–ü—Ä–æ–±–ª–µ–º–∞:** –ü–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è file_id helper –¥–ª—è –∞–¥–º–∏–Ω–æ–≤, —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–æ—Ç–æ –ø–µ—Ä–µ—Å—Ç–∞–ª–æ —Ä–∞–±–æ—Ç–∞—Ç—å. –ê–¥–º–∏–Ω—Å–∫–∏–µ —Ö–µ–Ω–¥–ª–µ—Ä—ã –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–ª–∏ –≤—Å–µ —Ñ–æ—Ç–æ –¥–æ —Ç–æ–≥–æ, –∫–∞–∫ –æ–Ω–∏ –¥–æ—Ö–æ–¥–∏–ª–∏ –¥–æ —Ö–µ–Ω–¥–ª–µ—Ä–æ–≤ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.

**–†–µ—à–µ–Ω–∏–µ:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω `StateFilter(None)` –≤ –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä–∞—Ö –∞–¥–º–∏–Ω—Å–∫–∏—Ö —Ö–µ–Ω–¥–ª–µ—Ä–æ–≤. –¢–µ–ø–µ—Ä—å –æ–Ω–∏ —Å—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç **—Ç–æ–ª—å–∫–æ –∫–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ù–ï –≤ FSM state**. –ö–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (`EditStates.waiting_image`), –∞–¥–º–∏–Ω—Å–∫–∏–µ —Ö–µ–Ω–¥–ª–µ—Ä—ã –∏–≥–Ω–æ—Ä–∏—Ä—É—é—Ç—Å—è, –∏ —Ñ–æ—Ç–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è —Ö–µ–Ω–¥–ª–µ—Ä–∞–º–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.

```python
# –ë—ã–ª–æ:
@router.message(F.photo)
async def handle_photo_file_id(message: Message, state: FSMContext):
    if not config.is_admin(message.from_user.id):
        return
    current_state = await state.get_state()
    if current_state is not None:
        return  # ‚ùå –•–µ–Ω–¥–ª–µ—Ä –≤—Å—ë —Ä–∞–≤–Ω–æ "–æ–±—Ä–∞–±–æ—Ç–∞–ª" —Å–æ–æ–±—â–µ–Ω–∏–µ
    ...

# –°—Ç–∞–ª–æ:
@router.message(
    StateFilter(None),  # ‚úÖ –•–µ–Ω–¥–ª–µ—Ä –≤–æ–æ–±—â–µ –Ω–µ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –µ—Å–ª–∏ –µ—Å—Ç—å state
    F.photo,
    lambda m: m.from_user and config.is_admin(m.from_user.id)
)
async def handle_photo_file_id(message: Message):
    ...
```

**–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç:**
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ FSM state (—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ) ‚Üí –∞–¥–º–∏–Ω—Å–∫–∏–π —Ö–µ–Ω–¥–ª–µ—Ä –Ω–µ —Ä–∞—Å—Å–º–∞—Ç—Ä–∏–≤–∞–µ—Ç—Å—è ‚Üí —Ñ–æ—Ç–æ –∏–¥—ë—Ç –∫ edit —Ö–µ–Ω–¥–ª–µ—Ä—É ‚úÖ
2. –ê–¥–º–∏–Ω –≤–Ω–µ FSM state ‚Üí –∞–¥–º–∏–Ω—Å–∫–∏–π —Ö–µ–Ω–¥–ª–µ—Ä —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç ‚Üí –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç file_id ‚úÖ

### 34. –£–ª—É—á—à–µ–Ω—ã –∫–æ–º–∞–Ω–¥—ã –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ª–æ–≥–æ–≤

**–§–∞–π–ª—ã:**
- `Makefile` ‚Äî –æ–±–Ω–æ–≤–ª–µ–Ω—ã –∫–æ–º–∞–Ω–¥—ã –¥–ª—è –ª–æ–≥–æ–≤
- `README.md` ‚Äî –æ–±–Ω–æ–≤–ª–µ–Ω–∞ —Å–µ–∫—Ü–∏—è Docker –∫–æ–º–∞–Ω–¥
- `Manuals/FAST_DEPLOY.md` ‚Äî –æ–±–Ω–æ–≤–ª–µ–Ω–∞ —Å–µ–∫—Ü–∏—è —Å –ª–æ–≥–∞–º–∏
- `Manuals/DEPLOYMENT.md` ‚Äî –æ–±–Ω–æ–≤–ª–µ–Ω–∞ —Å–µ–∫—Ü–∏—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞

**–ü—Ä–æ–±–ª–µ–º–∞:** –ü—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ `docker-compose logs -f` –≤ –ª–æ–≥–∞—Ö –ø–æ—è–≤–ª—è–µ—Ç—Å—è –æ—à–∏–±–∫–∞:
```
Exception in thread Thread-5 (watch_events):
KeyError: 'id'
```

–≠—Ç–æ –±–∞–≥ –≤ —Å—Ç–∞—Ä—ã—Ö –≤–µ—Ä—Å–∏—è—Ö `docker-compose` –ø—Ä–∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–µ —Å–æ–±—ã—Ç–∏–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤. –ù–µ –≤–ª–∏—è–µ—Ç –Ω–∞ —Ä–∞–±–æ—Ç—É, –Ω–æ –∑–∞—Å–æ—Ä—è–µ—Ç –ª–æ–≥–∏.

**–†–µ—à–µ–Ω–∏–µ:** –î–æ–±–∞–≤–ª–µ–Ω—ã –∫–æ–º–∞–Ω–¥—ã –¥–ª—è —á–∏—Å—Ç–æ–≥–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ª–æ–≥–æ–≤ —á–µ—Ä–µ–∑ `docker logs`:

```bash
# –ß–∏—Å—Ç—ã–µ –ª–æ–≥–∏ (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)
make logs              # –õ–æ–≥–∏ app
make logs-worker       # –õ–æ–≥–∏ worker
make logs-db           # –õ–æ–≥–∏ PostgreSQL
make logs-redis        # –õ–æ–≥–∏ Redis

# –ò–ª–∏ –Ω–∞–ø—Ä—è–º—É—é
docker logs -f telegram_bot_app
docker logs -f telegram_bot_worker

# –°—Ç–∞—Ä—ã–π —Å–ø–æ—Å–æ–± (—Å –æ—à–∏–±–∫–∞–º–∏ docker-compose)
make logs-all
docker-compose logs -f
```

**–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è:**
1. –û–±–Ω–æ–≤–∏—Ç—å docker-compose –¥–æ –≤–µ—Ä—Å–∏–∏ 2.x: `sudo apt-get install docker-compose-plugin`
2. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `docker compose` (v2, –±–µ–∑ –¥–µ—Ñ–∏—Å–∞) –≤–º–µ—Å—Ç–æ `docker-compose`
3. –ò–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å –æ—à–∏–±–∫—É: `docker-compose logs -f 2>/dev/null`

---

### 32. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–∞–≥–æ–≤ (6 issues)

#### 32.1 –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –º–æ–¥–µ—Ä–∞—Ü–∏–∏ OpenAI

**–§–∞–π–ª:** `bot/tasks/generation.py`

- –î–æ–±–∞–≤–ª–µ–Ω –∫–ª–∞—Å—Å `ModerationError` –¥–ª—è –æ—à–∏–±–æ–∫ –º–æ–¥–µ—Ä–∞—Ü–∏–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
- –û—à–∏–±–∫–∏ –º–æ–¥–µ—Ä–∞—Ü–∏–∏ –Ω–µ –ø–æ–≤—Ç–æ—Ä—è—é—Ç—Å—è (no retry) ‚Äî —Å—Ä–∞–∑—É –≤–æ–∑–≤—Ä–∞—Ç —Ç–æ–∫–µ–Ω–æ–≤
- –î–æ–±–∞–≤–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è `_send_moderation_notification()` ‚Äî —É–≤–µ–¥–æ–º–ª—è–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ –±–ª–æ–∫–∏—Ä–æ–≤–∫–µ
- –ê–¥–º–∏–Ω—ã –ø–æ–ª—É—á–∞—é—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ –º–æ–¥–µ—Ä–∞—Ü–∏–∏

–°–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é:
```
‚ö†Ô∏è –ó–∞–ø—Ä–æ—Å –æ—Ç–∫–ª–æ–Ω—ë–Ω –º–æ–¥–µ—Ä–∞—Ü–∏–µ–π

–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –≤–∞—à –∑–∞–ø—Ä–æ—Å –Ω–µ –ø—Ä–æ—à—ë–ª –ø—Ä–æ–≤–µ—Ä–∫—É –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ OpenAI.

–¢–æ–∫–µ–Ω—ã (X) –≤–æ–∑–≤—Ä–∞—â–µ–Ω—ã –Ω–∞ –≤–∞—à –±–∞–ª–∞–Ω—Å.

üí° –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –æ–ø–∏—Å–∞–Ω–∏–µ –∏ –∏–∑–±–µ–≥–∞—Ç—å –∑–∞–ø—Ä–µ—â—ë–Ω–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞.
```

#### 32.2 –ê–¥–º–∏–Ω-–∫–æ–º–∞–Ω–¥—ã –ø–æ @username

**–§–∞–π–ª:** `bot/handlers/admin.py`

–ö–æ–º–∞–Ω–¥—ã `/addtokens` –∏ `/userinfo` —Ç–µ–ø–µ—Ä—å –ø—Ä–∏–Ω–∏–º–∞—é—Ç –∫–∞–∫ telegram_id, —Ç–∞–∫ –∏ @username:
- `/addtokens @username 100`
- `/addtokens 123456789 100`
- `/userinfo @username`
- `/userinfo 123456789`

#### 32.3 –¢–æ–ø –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å @username –∏ telegram_id

**–§–∞–π–ª:** `bot/handlers/admin.py`

–í –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏ —Ç–æ–ø –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Ç–µ–ø–µ—Ä—å –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç:
```
1. @username (123456789) ‚Äî 50 –∑–∞–¥–∞—á
2. @‚Äî (987654321) ‚Äî 30 –∑–∞–¥–∞—á
```

#### 32.4 Role "sabrinar" –≤ –ª–æ–≥–∞—Ö –ë–î

**–°—Ç–∞—Ç—É—Å:** –ò–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç—Å—è

–≠—Ç–æ –≤–Ω–µ—à–Ω–∏–µ brute-force –∞—Ç–∞–∫–∏ –Ω–∞ PostgreSQL, –Ω–µ —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å –∫–æ–¥–æ–º –±–æ—Ç–∞. –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å fail2ban –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ.

#### 32.5 source_image_url —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π

**–§–∞–π–ª—ã:**
- `bot/db/models.py` ‚Äî –∏–∑–º–µ–Ω–µ–Ω–æ —Å `String(500)` –Ω–∞ `String(2000)`
- `alembic/versions/20260105_extend_source_image_url.py` ‚Äî –º–∏–≥—Ä–∞—Ü–∏—è

#### 32.6 –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –ø–æ–≤–µ–¥–µ–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ üëé

**–§–∞–π–ª:** `bot/handlers/feedback.py`

**–ë—ã–ª–æ:** –ö–Ω–æ–ø–∫–∞ üëé –ø–æ–∫–∞–∑—ã–≤–∞–ª–∞ "–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞", –∫–æ—Ç–æ—Ä–∞—è —Å—Ä–∞–∑—É —Ä–µ–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–ª–∞ –±–µ–∑ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –∏–∑–º–µ–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏.

**–°—Ç–∞–ª–æ:** –ö–Ω–æ–ø–∫–∞ üëé —Ç–µ–ø–µ—Ä—å –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –º–µ–Ω—é –Ω–∞—Å—Ç—Ä–æ–µ–∫ (–∫–∞–∫ –∫–Ω–æ–ø–∫–∞ "üîÑ –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –µ—â—ë"), –≥–¥–µ –º–æ–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å –∫–∞—á–µ—Å—Ç–≤–æ –∏ —Ä–∞–∑–º–µ—Ä –ø–µ—Ä–µ–¥ –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–µ–π.

–°–æ–æ–±—â–µ–Ω–∏–µ:
```
üòî –ñ–∞–ª—å, —á—Ç–æ –Ω–µ –ø–æ–Ω—Ä–∞–≤–∏–ª–æ—Å—å

–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏:

–í–∞—à –ø—Ä–æ–º–ø—Ç: ...
–ú–æ–¥–µ–ª—å: gpt-image-1.5
–ö–∞—á–µ—Å—Ç–≤–æ: medium
–§–æ—Ä–º–∞—Ç: 1024x1024

–°—Ç–æ–∏–º–æ—Å—Ç—å: 5 ü™ô
–í–∞—à –±–∞–ª–∞–Ω—Å: 100 ü™ô
–ü–æ—Å–ª–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏: 95 ü™ô

–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –≥–µ–Ω–µ—Ä–∞—Ü–∏—é?
```

#### 32.7 –ó–∞–∫—Ä—ã—Ç—ã –ø–æ—Ä—Ç—ã –ë–î –∏ Redis –æ—Ç –≤–Ω–µ—à–Ω–µ–≥–æ –¥–æ—Å—Ç—É–ø–∞

**–§–∞–π–ª:** `docker-compose.yml`

**–ë—ã–ª–æ:** –ü–æ—Ä—Ç—ã PostgreSQL (5432) –∏ Redis (6379) –±—ã–ª–∏ –æ—Ç–∫—Ä—ã—Ç—ã –¥–ª—è –≤—Å–µ—Ö IP-–∞–¥—Ä–µ—Å–æ–≤, —á—Ç–æ –ø–æ–∑–≤–æ–ª—è–ª–æ –≤–Ω–µ—à–Ω–∏–º –∞—Ç–∞–∫–∞–º (brute-force).

**–°—Ç–∞–ª–æ:** –ü–æ—Ä—Ç—ã –ø—Ä–∏–≤—è–∑–∞–Ω—ã –∫ `127.0.0.1` ‚Äî –¥–æ—Å—Ç—É–ø —Ç–æ–ª—å–∫–æ —Å —Å–∞–º–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞:
```yaml
ports:
  - "127.0.0.1:5432:5432"  # PostgreSQL
  - "127.0.0.1:6379:6379"  # Redis
```

–î–ª—è —Ä–∞–±–æ—Ç—ã –±–æ—Ç–∞ —ç—Ç–æ –Ω–µ –≤–ª–∏—è–µ—Ç ‚Äî –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –æ–±—â–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ –≤–Ω—É—Ç—Ä–µ–Ω–Ω—é—é —Å–µ—Ç—å Docker.

#### 32.8 –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –æ—Ç–ø—Ä–∞–≤–∫–∞ –≤–∏–¥–µ–æ-–∫—Ä—É–∂–∫–∞

**–§–∞–π–ª—ã:**
- `docker-compose.yml` ‚Äî –¥–æ–±–∞–≤–ª–µ–Ω–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è `WELCOME_VIDEO_FILE_ID`
- `bot/handlers/start.py` ‚Äî —É–ø—Ä–æ—â–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏

**–ë—ã–ª–æ:** –í–∏–¥–µ–æ –æ—Ç–ø—Ä–∞–≤–ª—è–ª–æ—Å—å —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã—Ö —É—Å–ª–æ–≤–∏—è—Ö (subscription_required), –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –Ω–µ –ø–µ—Ä–µ–¥–∞–≤–∞–ª–∞—Å—å –≤ Docker.

**–°—Ç–∞–ª–æ:** –í–∏–¥–µ–æ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –í–°–ï–ú –Ω–æ–≤—ã–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º —Å—Ä–∞–∑—É –ø—Ä–∏ /start, –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç –Ω–∞—Å—Ç—Ä–æ–µ–∫ –ø–æ–¥–ø–∏—Å–∫–∏.

#### 32.9 –°–µ—Ä–≤–∏—Å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –∞–¥–º–∏–Ω–æ–≤

**–ù–æ–≤—ã–π —Ñ–∞–π–ª:** `bot/services/admin_notify.py`

–¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π —Å–µ—Ä–≤–∏—Å –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –∞–¥–º–∏–Ω–∞–º:
- `notify_admins(message, title)` ‚Äî –æ–±—â–µ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
- `notify_error(error, context, user_id)` ‚Äî —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
- `notify_moderation_block(...)` ‚Äî —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –±–ª–æ–∫–∏—Ä–æ–≤–∫–µ –º–æ–¥–µ—Ä–∞—Ü–∏–µ–π
- `notify_generation_failure(...)` ‚Äî —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏

–ú–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∏–∑ –ª—é–±–æ–≥–æ –º–µ—Å—Ç–∞ –≤ –∫–æ–¥–µ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π.

#### 32.10 –£–ª—É—á—à–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π

**–§–∞–π–ª:** `bot/tasks/generation.py`

–î–æ–±–∞–≤–ª–µ–Ω–æ –¥–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ—Ü–µ—Å—Å–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ base64 –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π:
- –†–∞–∑–º–µ—Ä base64 —Å—Ç—Ä–æ–∫–∏
- –†–∞–∑–º–µ—Ä –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –±–∞–π—Ç–æ–≤
- –≠—Ç–∞–ø—ã —Å–æ–∑–¥–∞–Ω–∏—è –∏ –æ—Ç–ø—Ä–∞–≤–∫–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞

–ü–æ–º–æ–≥–∞–µ—Ç –¥–∏–∞–≥–Ω–æ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–¥–µ—Ä–∂–∫–∏ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –±–æ–ª—å—à–∏—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π.

#### 32.11 File ID helper –¥–ª—è –∞–¥–º–∏–Ω–æ–≤

**–§–∞–π–ª:** `bot/handlers/admin.py`

–¢–µ–ø–µ—Ä—å –∞–¥–º–∏–Ω—ã –º–æ–≥—É—Ç –ø–æ–ª—É—á–∏—Ç—å file_id –ª—é–±–æ–≥–æ —Ñ–∞–π–ª–∞ –ø—Ä–æ—Å—Ç–æ –æ—Ç–ø—Ä–∞–≤–∏–≤ –µ–≥–æ –±–æ—Ç—É:
- üìπ –í–∏–¥–µ–æ-–∫—Ä—É–∂–∫–∏ (video_note) ‚Äî –¥–ª—è `WELCOME_VIDEO_FILE_ID`
- üñº –§–æ—Ç–æ (photo)
- üé• –í–∏–¥–µ–æ (video)
- üìÑ –î–æ–∫—É–º–µ–Ω—Ç—ã (document)

–ë–æ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–≤–µ—Ç–∏—Ç —Å file_id –∏ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–µ–π.

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**
1. –û—Ç–ø—Ä–∞–≤—å –≤–∏–¥–µ–æ-–∫—Ä—É–∂–æ–∫ –±–æ—Ç—É
2. –ë–æ—Ç –ø–æ–∫–∞–∂–µ—Ç file_id
3. –°–∫–æ–ø–∏—Ä—É–π –≤ .env
4. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏ –±–æ—Ç–∞

**–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è:** `Manuals/GET_VIDEO_FILE_ID.md`

---

### 31. 9 –Ω–æ–≤—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π –¥–ª—è –±–æ—Ç–∞

**–°–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è:** `.kiro/specs/nine-features/`

#### 31.1 –£–ø—Ä–æ—â—ë–Ω–Ω—ã–π –ø—Ä–æ—Ñ–∏–ª—å

**–§–∞–π–ª:** `bot/handlers/profile.py`

- –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ç–æ–ª—å–∫–æ 3 –ø–æ—Å–ª–µ–¥–Ω–∏–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –≤–º–µ—Å—Ç–æ 10
- –£–±—Ä–∞–Ω—ã –∫–Ω–æ–ø–∫–∏ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∏—Å—Ç–æ—Ä–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
- –û—Å—Ç–∞–≤–ª–µ–Ω–∞ —Ç–æ–ª—å–∫–æ –∫–Ω–æ–ø–∫–∞ "‚óÄÔ∏è –ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é"

#### 31.2 –°–ø—Ä–∞–≤–∫–∞ –ø–æ –∞–¥–º–∏–Ω-–∫–æ–º–∞–Ω–¥–∞–º

**–§–∞–π–ª:** `bot/handlers/admin.py`

- –î–æ–±–∞–≤–ª–µ–Ω–∞ –∫–æ–Ω—Å—Ç–∞–Ω—Ç–∞ `ADMIN_HELP_TEXT` —Å–æ —Å–ø–∏—Å–∫–æ–º –≤—Å–µ—Ö –∫–æ–º–∞–Ω–¥
- –ö–æ–º–∞–Ω–¥–∞ `/adminhelp` ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–ø—Ä–∞–≤–∫—É
- –ö–Ω–æ–ø–∫–∞ "üìã –°–ø—Ä–∞–≤–∫–∞" –≤ –∞–¥–º–∏–Ω-–º–µ–Ω—é
- Callback handler `admin:help`

#### 31.3 –°–±—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

**–§–∞–π–ª—ã:**
- `bot/db/repositories.py` ‚Äî –º–µ—Ç–æ–¥ `get_by_username()`
- `bot/handlers/admin.py` ‚Äî –∫–æ–º–∞–Ω–¥–∞ `/resetuser`

–ö–æ–º–∞–Ω–¥–∞ `/resetuser <@username|telegram_id>` —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç:
- –¢–æ–∫–µ–Ω—ã ‚Üí 7 (initial_tokens)
- –ú–æ–¥–µ–ª—å ‚Üí gpt-image-1.5
- –ö–∞—á–µ—Å—Ç–≤–æ ‚Üí medium
- –†–∞–∑–º–µ—Ä ‚Üí 1024x1024

#### 31.4 –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–∞ –∫–∞–Ω–∞–ª

**–§–∞–π–ª—ã:**
- `bot/config.py` ‚Äî `subscription_channel`, `subscription_required`, `welcome_video_file_id`
- `bot/handlers/start.py` ‚Äî —Ñ—É–Ω–∫—Ü–∏—è `check_subscription()`, callback `check_subscription`
- `bot/keyboards/inline.py` ‚Äî `subscription_keyboard()`
- `bot/handlers/admin.py` ‚Äî Redis —Ñ—É–Ω–∫—Ü–∏–∏ `get_subscription_required()`, `set_subscription_required()`

–ù–æ–≤—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –¥–æ–ª–∂–Ω—ã –ø–æ–¥–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –∫–∞–Ω–∞–ª –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–æ–≤ (–µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–æ).

#### 31.5 –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å –ø–æ–¥–ø–∏—Å–∫–∏ –¥–ª—è –∞–¥–º–∏–Ω–∞

**–§–∞–π–ª:** `bot/handlers/admin.py`

- –ö–æ–º–∞–Ω–¥–∞ `/togglesub` ‚Äî –≤–∫–ª/–≤—ã–∫–ª –ø—Ä–æ–≤–µ—Ä–∫—É –ø–æ–¥–ø–∏—Å–∫–∏
- –ö–Ω–æ–ø–∫–∞ "üîî –ü–æ–¥–ø–∏—Å–∫–∞" –≤ –∞–¥–º–∏–Ω-–º–µ–Ω—é
- –°–æ—Å—Ç–æ—è–Ω–∏–µ —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ Redis

#### 31.6 –í–∏–¥–µ–æ-–∫—Ä—É–∂–æ–∫ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ

**–§–∞–π–ª:** `bot/handlers/start.py`

- –û—Ç–ø—Ä–∞–≤–∫–∞ video_note –ø–æ—Å–ª–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `config.welcome_video_file_id`
- Graceful handling –µ—Å–ª–∏ file_id –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–π

#### 31.7 –ö–Ω–æ–ø–∫–∏ –æ—Ü–µ–Ω–∫–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ (üëç/üëé)

**–§–∞–π–ª—ã:**
- `bot/keyboards/inline.py` ‚Äî `result_feedback_keyboard()`, `negative_feedback_keyboard()`
- `bot/handlers/feedback.py` ‚Äî handlers –¥–ª—è positive/negative feedback –∏ retry
- `bot/tasks/generation.py` ‚Äî –∑–∞–º–µ–Ω–µ–Ω–∞ `regenerate_keyboard` –Ω–∞ `result_feedback_keyboard`
- `bot/handlers/__init__.py` ‚Äî —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è `feedback_router`

–ü–æ—Å–ª–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è –∫–Ω–æ–ø–∫–∏:
- üëç ‚Äî –±–ª–∞–≥–æ–¥–∞—Ä–∏—Ç –∑–∞ –æ—Ç–∑—ã–≤
- üëé ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∫–Ω–æ–ø–∫—É "–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞"
- üîÑ –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –µ—â—ë ‚Äî –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç —ç–∫—Ä–∞–Ω –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è

#### 31.8 –ü–æ–¥–∞—Ä–∫–∏ (–∑–∞–≥–ª—É—à–∫–∞)

**–§–∞–π–ª—ã:**
- `bot/keyboards/inline.py` ‚Äî `CallbackData.GIFT`, –∫–Ω–æ–ø–∫–∞ –≤ –≥–ª–∞–≤–Ω–æ–º –º–µ–Ω—é
- `bot/handlers/gift.py` ‚Äî placeholder "coming soon"
- `bot/handlers/__init__.py` ‚Äî —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è `gift_router`

–ö–Ω–æ–ø–∫–∞ "üéÅ –ü–æ–¥–∞—Ä–∏—Ç—å —Ñ–æ—Ç–æ—Å–µ—Å—Å–∏—é" –≤ –≥–ª–∞–≤–Ω–æ–º –º–µ–Ω—é –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –æ —Å–∫–æ—Ä–æ–º –∑–∞–ø—É—Å–∫–µ —Ñ—É–Ω–∫—Ü–∏–∏.

#### 31.9 –†–∞—Å—Å—ã–ª–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π

**–§–∞–π–ª—ã:**
- `bot/states/admin.py` ‚Äî `BroadcastStates` (FSM)
- `bot/db/repositories.py` ‚Äî –º–µ—Ç–æ–¥ `get_all_users()`
- `bot/handlers/admin.py` ‚Äî –∫–æ–º–∞–Ω–¥–∞ `/broadcast`

–ö–æ–º–∞–Ω–¥–∞ `/broadcast`:
1. –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ (—Ç–µ–∫—Å—Ç/—Ñ–æ—Ç–æ/–≤–∏–¥–µ–æ)
2. –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π
3. –¢—Ä–µ–±—É–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
4. –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å –ø—Ä–æ–≥—Ä–µ—Å—Å–æ–º (–æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –∫–∞–∂–¥—ã–µ 50 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π)
5. –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∏—Ç–æ–≥–∏ (—É—Å–ø–µ—à–Ω–æ/–æ—à–∏–±–∫–∏)

#### Property-based —Ç–µ—Å—Ç—ã

**–§–∞–π–ª:** `tests/test_admin_properties.py`

- Property 2: User Reset Restores Defaults
- Property 3: Token Addition Accuracy
- Property 4: Subscription Toggle Persistence
- Property 6: Regeneration Token Cost (2 —Ç–µ—Å—Ç–∞)

#### –ù–æ–≤—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

| –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è | –û–ø–∏—Å–∞–Ω–∏–µ |
|------------|----------|
| `SUBSCRIPTION_CHANNEL` | –ö–∞–Ω–∞–ª –¥–ª—è –ø–æ–¥–ø–∏—Å–∫–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä @nkonshin_ai) |
| `SUBSCRIPTION_REQUIRED` | –¢—Ä–µ–±–æ–≤–∞—Ç—å –ø–æ–¥–ø–∏—Å–∫—É (true/false) |
| `WELCOME_VIDEO_FILE_ID` | File ID –≤–∏–¥–µ–æ-–∫—Ä—É–∂–∫–∞ –¥–ª—è –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è |

---

## –î–∞—Ç–∞: 4 —è–Ω–≤–∞—Ä—è 2026

### 29. –ù–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞ —Ç–æ–∫–µ–Ω–æ–º–∏–∫–∏

**–§–∞–π–ª—ã:**
- `bot/services/image_tokens.py` ‚Äî –Ω–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ —Ä–∞—Å—á—ë—Ç–∞ —Å—Ç–æ–∏–º–æ—Å—Ç–∏
- `bot/db/models.py` ‚Äî –Ω–æ–≤—ã–µ –ø–æ–ª—è `api_tokens_spent`, `images_count`
- `bot/config.py` ‚Äî `initial_tokens = 7`
- `bot/db/repositories.py` ‚Äî –ø–æ–¥–¥–µ—Ä–∂–∫–∞ `images_count`, `api_tokens_spent`
- `bot/keyboards/inline.py` ‚Äî –Ω–æ–≤—ã–π –º–∞–≥–∞–∑–∏–Ω, `insufficient_balance_keyboard()`
- `bot/handlers/menu.py` ‚Äî –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –º–∞–≥–∞–∑–∏–Ω–∞
- `bot/handlers/generate.py` ‚Äî –Ω–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ –Ω–µ–¥–æ—Å—Ç–∞—Ç–∫–µ —Ç–æ–∫–µ–Ω–æ–≤
- `bot/handlers/edit.py` ‚Äî –Ω–æ–≤—ã–π —Ä–∞—Å—á—ë—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –¥–ª—è –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Ñ–æ—Ç–æ
- `bot/handlers/trends.py` ‚Äî –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
- `bot/handlers/profile.py` ‚Äî –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–∞—á–µ—Å—Ç–≤–∞ —Å –ª–µ–π–±–ª–∞–º–∏
- `bot/tasks/generation.py` ‚Äî –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ API —Ç–æ–∫–µ–Ω–æ–≤

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**

1. **–ù–æ–≤—ã–µ —Ü–µ–Ω—ã (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ —Ç–æ–∫–µ–Ω—ã):**
   - Low (–ë—ã—Å—Ç—Ä–æ–µ): 2 —Ç–æ–∫–µ–Ω–∞
   - Medium (–°—Ç–∞–Ω–¥–∞—Ä—Ç): 5 —Ç–æ–∫–µ–Ω–æ–≤
   - High (–ú–∞–∫—Å–∏–º—É–º): 20 —Ç–æ–∫–µ–Ω–æ–≤

2. **–°—Ç–æ–∏–º–æ—Å—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π:**
   - 1-3 —Ñ–æ—Ç–æ: –±–µ—Å–ø–ª–∞—Ç–Ω–æ
   - 4-6 —Ñ–æ—Ç–æ: +1 —Ç–æ–∫–µ–Ω
   - 7-10 —Ñ–æ—Ç–æ: +2 —Ç–æ–∫–µ–Ω–∞

3. **–ù–∞—á–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å:** 7 —Ç–æ–∫–µ–Ω–æ–≤ –¥–ª—è –Ω–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

4. **–ú–∞–≥–∞–∑–∏–Ω:**
   - üê£ Starter ‚Äî 99 ‚ÇΩ (10 —Ç–æ–∫–µ–Ω–æ–≤)
   - ‚ú® Small ‚Äî 249 ‚ÇΩ (50 —Ç–æ–∫–µ–Ω–æ–≤) ‚Äî –°–∫–∏–¥–∫–∞ 50%
   - üî• Medium ‚Äî 449 ‚ÇΩ (120 —Ç–æ–∫–µ–Ω–æ–≤) ‚Äî –•–ò–¢, –°–∫–∏–¥–∫–∞ 62%
   - üòé Pro ‚Äî 890 ‚ÇΩ (300 —Ç–æ–∫–µ–Ω–æ–≤) ‚Äî –°–∫–∏–¥–∫–∞ 70%
   - üëë Vip ‚Äî 1690 ‚ÇΩ (700 —Ç–æ–∫–µ–Ω–æ–≤) ‚Äî –°–∫–∏–¥–∫–∞ 75%

5. **–ú–æ–¥–µ–ª–∏:**
   - GPT Image 1 ‚Äî –æ—Ç–º–µ—á–µ–Ω–∞ –∫–∞–∫ "—É—Å—Ç–∞—Ä–µ–≤—à–∞—è", –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ –¥–ª—è –≤—ã–±–æ—Ä–∞
   - GPT Image 1.5 ‚Äî –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–∞—è –¥–æ—Å—Ç—É–ø–Ω–∞—è –º–æ–¥–µ–ª—å

6. **–û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ API —Ç–æ–∫–µ–Ω–æ–≤:**
   - –ü–æ–ª–µ `api_tokens_spent` –≤ User –∏ GenerationTask
   - –î–ª—è –∞–¥–º–∏–Ω—Å–∫–æ–π –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –∏ —Å–≤–µ—Ä–∫–∏ —Å OpenAI

7. **–ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –Ω–µ–¥–æ—Å—Ç–∞—Ç–∫–µ —Ç–æ–∫–µ–Ω–æ–≤:**
   ```
   –û–π! –ö–∞–∂–µ—Ç—Å—è, —Ç–æ–∫–µ–Ω—ã –∑–∞–∫–æ–Ω—á–∏–ª–∏—Å—å üì∏
   
   –¢—Ä–µ–±—É–µ—Ç—Å—è: X ü™ô
   –í–∞—à –±–∞–ª–∞–Ω—Å: Y ü™ô
   
   –ü–æ–ø–æ–ª–Ω–∏ –±–∞–ª–∞–Ω—Å –≤ –º–∞–≥–∞–∑–∏–Ω–µ, —á—Ç–æ–±—ã –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å! üëæ
   ```

### 30. –ú–∏–≥—Ä–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

**–§–∞–π–ª:** `alembic/versions/e1f2a3b4c5d6_add_token_economy_fields.py`

- –î–æ–±–∞–≤–ª—è–µ—Ç `api_tokens_spent` –≤ —Ç–∞–±–ª–∏—Ü—É `users`
- –î–æ–±–∞–≤–ª—è–µ—Ç `api_tokens_spent` –∏ `images_count` –≤ —Ç–∞–±–ª–∏—Ü—É `generation_tasks`
- –°–±—Ä–∞—Å—ã–≤–∞–µ—Ç —Ç–æ–∫–µ–Ω—ã –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –¥–æ 7
- –û–±–Ω–æ–≤–ª—è–µ—Ç –º–æ–¥–µ–ª—å –Ω–∞ `gpt-image-1.5`

**–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ:**
```bash
# –í Docker
docker-compose exec app alembic upgrade head
```

---

## –î–∞—Ç–∞: 28 –¥–µ–∫–∞–±—Ä—è 2025, 15:30

### 20. –û—Ç–ø—Ä–∞–≤–∫–∞ –≤—Å–µ—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –≤ OpenAI API

**–§–∞–π–ª:** `bot/services/image_provider.py`

–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –ø–µ—Ä–µ–¥–∞—á–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –≤ OpenAI edit endpoint. –¢–µ–ø–µ—Ä—å –ø–µ—Ä–µ–¥–∞—ë—Ç—Å—è –º–∞—Å—Å–∏–≤ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π (–¥–æ 16 —à—Ç—É–∫) –≤–º–µ—Å—Ç–æ —Ç–æ–ª—å–∫–æ –ø–µ—Ä–≤–æ–≥–æ.

```python
# –ë—ã–ª–æ:
image=primary_image

# –°—Ç–∞–ª–æ:
image_param = image_files if len(image_files) > 1 else image_files[0]
image=image_param
```

### 21. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ HTML —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞

**–§–∞–π–ª:** `bot/tasks/generation.py`

–î–æ–±–∞–≤–ª–µ–Ω `parse_mode="HTML"` –≤ `send_document` –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ç–µ–≥–æ–≤ `<b>`, `<blockquote>`, `<i>`.

### 22. –£–ø—Ä–æ—â–µ–Ω–æ –∏–º—è —Ñ–∞–π–ª–∞

**–§–∞–π–ª:** `bot/tasks/generation.py`

–ò–º—è —Ñ–∞–π–ª–∞ –∏–∑–º–µ–Ω–µ–Ω–æ —Å `GPT_Image_{task_id}.png` –Ω–∞ –ø—Ä–æ—Å—Ç–æ–µ `GPT_Image.png`.

### 23. –ê–Ω–∏–º–∞—Ü–∏—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
  
**–§–∞–π–ª:** `bot/tasks/generation.py`

–î–æ–±–∞–≤–ª–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ "‚è≥ –ì–µ–Ω–µ—Ä–∏—Ä—É—é..." –∫–æ—Ç–æ—Ä–æ–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –ø—Ä–∏ –Ω–∞—á–∞–ª–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–¥–∞–ª—è–µ—Ç—Å—è –ø–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –∏–ª–∏ –æ—à–∏–±–∫–∏.

–ù–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:
- `_send_animation_message()` - –æ—Ç–ø—Ä–∞–≤–∫–∞ –∞–Ω–∏–º–∞—Ü–∏–æ–Ω–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
- `_delete_animation_message()` - —É–¥–∞–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è

### 24. –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∞–¥–º–∏–Ω–æ–≤ –æ–± –æ—à–∏–±–∫–∞—Ö

**–§–∞–π–ª:** `bot/tasks/generation.py`

–ü—Ä–∏ –æ—à–∏–±–∫–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ç–µ–ø–µ—Ä—å –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤—Å–µ–º –∞–¥–º–∏–Ω–∞–º –∏–∑ `ADMIN_IDS` —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π:
- Task ID
- User ID –∏ Telegram ID
- Username
- –¢–∏–ø –∑–∞–¥–∞—á–∏ –∏ –º–æ–¥–µ–ª—å
- –ü—Ä–æ–º–ø—Ç (–ø–µ—Ä–≤—ã–µ 200 —Å–∏–º–≤–æ–ª–æ–≤)
- –¢–µ–∫—Å—Ç –æ—à–∏–±–∫–∏

–ù–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è: `_notify_admins_about_error()`

### 25. –û–±–Ω–æ–≤–ª—ë–Ω —Ç–µ–∫—Å—Ç –ø–æ–ª—É—á–µ–Ω–∏—è —Ñ–æ—Ç–æ

**–§–∞–π–ª:** `bot/handlers/edit.py`

–ù–æ–≤—ã–π —Ç–µ–∫—Å—Ç –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Ñ–æ—Ç–æ:
```
‚úÖ –§–æ—Ç–æ –ø–æ–ª—É—á–µ–Ω–æ! (1/10)

–û–ø–∏—à–∏—Ç–µ, —á—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º.

üí° –ü—Ä–∏–º–µ—Ä—ã:
‚Ä¢ ¬´–°–¥–µ–ª–∞–π –ø–æ—Ä—Ç—Ä–µ—Ç –≤ —Å—Ç—É–¥–∏–π–Ω–æ–º —Å–≤–µ—Ç–µ¬ª
‚Ä¢ ¬´–ó–∞–º–µ–Ω–∏ —Ñ–æ–Ω –Ω–∞ –≥–æ—Ä–æ–¥ –Ω–æ—á—å—é —Å –Ω–µ–æ–Ω–æ–≤—ã–º–∏ –æ–≥–Ω—è–º–∏¬ª
‚Ä¢ ¬´–°–æ–∑–¥–∞–π –∞—Ç–º–æ—Å—Ñ–µ—Ä—É –∫–∞–∫ –≤ –∫–∏–Ω–æ: –º—è–≥–∫–∏–π —Å–≤–µ—Ç, –≥–ª—É–±–∏–Ω–∞ —Ä–µ–∑–∫–æ—Å—Ç–∏¬ª

üí° –ï—Å–ª–∏ –≤—ã –∑–∞–≥—Ä—É–∑–∏–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ñ–æ—Ç–æ, –≤—ã –º–æ–∂–µ—Ç–µ:
‚Ä¢ ¬´–°–æ–µ–¥–∏–Ω–∏ —á–µ–ª–æ–≤–µ–∫–∞ —Å –ø–µ—Ä–≤–æ–≥–æ —Ñ–æ—Ç–æ —Å –ª–æ–∫–∞—Ü–∏–µ–π —Å–æ –≤—Ç–æ—Ä–æ–≥–æ¬ª
‚Ä¢ ¬´–°–æ–±–µ—Ä–∏ –æ–¥–Ω–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ, –∏—Å–ø–æ–ª—å–∑—É—è –ª—É—á—à–∏–µ –¥–µ—Ç–∞–ª–∏ –∏–∑ –≤—Å–µ—Ö —Ñ–æ—Ç–æ¬ª
‚Ä¢ ¬´–í–æ–∑—å–º–∏ —Å—Ç–∏–ª—å –æ—Å–≤–µ—â–µ–Ω–∏—è —Å –æ–¥–Ω–æ–≥–æ —Å–Ω–∏–º–∫–∞ –∏ –ø—Ä–∏–º–µ–Ω–∏ –∫ –¥—Ä—É–≥–æ–º—É¬ª

üìé –ú–æ–∂–µ—Ç–µ –¥–æ–±–∞–≤–∏—Ç—å –µ—â—ë —Ñ–æ—Ç–æ (–¥–æ 10) –∏–ª–∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ
```

### 26. –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π –∑–∞–≥–æ–ª–æ–≤–æ–∫ –¥–ª—è 2+ —Ñ–æ—Ç–æ

**–§–∞–π–ª:** `bot/handlers/edit.py`

–ü—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ 2+ —Ñ–æ—Ç–æ –∑–∞–≥–æ–ª–æ–≤–æ–∫ –º–µ–Ω—è–µ—Ç—Å—è –Ω–∞ "‚úÖ –ü–æ–ª—É—á–µ–Ω–æ —Ñ–æ—Ç–æ: 2/10" –≤–º–µ—Å—Ç–æ "‚úÖ –§–æ—Ç–æ –ø–æ–ª—É—á–µ–Ω–æ! (1/10)".

### 27. Batch-–∑–∞–≥—Ä—É–∑–∫–∞ —Ñ–æ—Ç–æ

**–§–∞–π–ª:** `bot/handlers/edit.py`

–ü—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Ñ–æ—Ç–æ –∑–∞ —Ä–∞–∑ (media group) —Ç–µ–ø–µ—Ä—å –ø—Ä–∏—Ö–æ–¥–∏—Ç –æ–¥–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤–º–µ—Å—Ç–æ –æ—Ç–¥–µ–ª—å–Ω–æ–≥–æ –Ω–∞ –∫–∞–∂–¥–æ–µ —Ñ–æ—Ç–æ. –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ —á–µ—Ä–µ–∑ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ `media_group_id`.

### 28. –°–±—Ä–æ—Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ "–ù–∞–∑–∞–¥"

**–§–∞–π–ª:** `bot/handlers/menu.py`

–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ, —á—Ç–æ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ `back_to_menu` –≤—ã–∑—ã–≤–∞–µ—Ç `state.clear()`, —á—Ç–æ —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç –≤—Å–µ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø—Ä–∏ –≤–æ–∑–≤—Ä–∞—Ç–µ –≤ –º–µ–Ω—é.

---

## –î–∞—Ç–∞: 26 –¥–µ–∫–∞–±—Ä—è 2025

### 1. –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–∞—Ü–∏—è –∫–æ–Ω—Å—Ç–∞–Ω—Ç –≤ config.py

**–ë—ã–ª–æ:** `HIGH_COST_THRESHOLD = 4000` –¥—É–±–ª–∏—Ä–æ–≤–∞–ª—Å—è –≤ 3 —Ñ–∞–π–ª–∞—Ö

**–°—Ç–∞–ª–æ:** –ï–¥–∏–Ω–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è `config.high_cost_threshold` –∏–∑ ENV

**–§–∞–π–ª—ã:**
- `bot/config.py` ‚Äî –¥–æ–±–∞–≤–ª–µ–Ω—ã –Ω–æ–≤—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
- `bot/handlers/generate.py` ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `config.high_cost_threshold`
- `bot/handlers/edit.py` ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `config.high_cost_threshold`
- `bot/handlers/trends.py` ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `config.high_cost_threshold`

### 2. –ù–æ–≤—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

| –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è | –û–ø–∏—Å–∞–Ω–∏–µ |
|------------|----------|
| `HIGH_COST_THRESHOLD` | –ü–æ—Ä–æ–≥ –¥–ª—è –¥–≤–æ–π–Ω–æ–≥–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è (default: 20 —Ç–æ–∫–µ–Ω–æ–≤) |
| `MAX_TASKS_PER_USER_PER_HOUR` | Rate limiting (default: 20) |
| `ADMIN_IDS` | Telegram ID –∞–¥–º–∏–Ω–æ–≤ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é |
| `ADMIN_API_KEY` | API –∫–ª—é—á –¥–ª—è HTTP –∞–¥–º–∏–Ω-—ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤ |

### 3. –°–µ—Ä–≤–∏—Å —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–¥–∞—á (task_service.py)

**–ù–æ–≤—ã–π —Ñ–∞–π–ª:** `bot/services/task_service.py`

–¶–µ–Ω—Ç—Ä–∞–ª–∏–∑—É–µ—Ç –ª–æ–≥–∏–∫—É —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–¥–∞—á:
- –ü—Ä–æ–≤–µ—Ä–∫–∞ rate limiting
- –°–ø–∏—Å–∞–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤
- –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏ –≤ –ë–î
- –ü–æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤ –æ—á–µ—Ä–µ–¥—å RQ

### 4. –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ (StatsRepository)

**–§–∞–π–ª:** `bot/db/repositories.py`

–ù–æ–≤—ã–µ –º–µ—Ç–æ–¥—ã:
- `get_total_users()` ‚Äî –≤—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- `get_total_tasks()` ‚Äî –≤—Å–µ–≥–æ –∑–∞–¥–∞—á
- `get_tasks_by_status()` ‚Äî –∑–∞–¥–∞—á–∏ –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º
- `get_total_tokens_spent()` ‚Äî –ø–æ—Ç—Ä–∞—á–µ–Ω–æ —Ç–æ–∫–µ–Ω–æ–≤
- `get_tasks_today()` ‚Äî –∑–∞–¥–∞—á —Å–µ–≥–æ–¥–Ω—è
- `get_users_today()` ‚Äî –Ω–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å–µ–≥–æ–¥–Ω—è
- `get_active_users_today()` ‚Äî –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–µ–≥–æ–¥–Ω—è
- `get_top_users()` ‚Äî —Ç–æ–ø –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- `get_model_usage()` ‚Äî –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –º–æ–¥–µ–ª–µ–π
- `get_full_stats()` ‚Äî –ø–æ–ª–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞

### 5. Rate Limiting

**–§–∞–π–ª:** `bot/db/repositories.py`

–ù–æ–≤—ã–π –º–µ—Ç–æ–¥ `count_user_tasks_since(user_id, hours)` –¥–ª—è –ø–æ–¥—Å—á—ë—Ç–∞ –∑–∞–¥–∞—á –∑–∞ –ø–µ—Ä–∏–æ–¥.

### 6. –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å (Telegram)

**–ù–æ–≤—ã–π —Ñ–∞–π–ª:** `bot/handlers/admin.py`

–ö–æ–º–∞–Ω–¥—ã:
- `/admin` ‚Äî –º–µ–Ω—é —Å –∫–Ω–æ–ø–∫–∞–º–∏
- `/stats` ‚Äî —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
- `/addtokens <id> <amount>` ‚Äî –¥–æ–±–∞–≤–∏—Ç—å —Ç–æ–∫–µ–Ω—ã
- `/userinfo <id>` ‚Äî –∏–Ω—Ñ–æ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ

### 7. –ê–¥–º–∏–Ω API (HTTP)

**–§–∞–π–ª:** `bot/main.py`

–≠–Ω–¥–ø–æ–∏–Ω—Ç—ã (—Ç—Ä–µ–±—É—é—Ç `X-Admin-API-Key`):
- `GET /admin/stats` ‚Äî —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
- `GET /admin/queue` ‚Äî –æ—á–µ—Ä–µ–¥—å RQ
- `GET /admin/users/{telegram_id}` ‚Äî –∏–Ω—Ñ–æ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
- `POST /admin/users/{telegram_id}/tokens` ‚Äî –¥–æ–±–∞–≤–∏—Ç—å —Ç–æ–∫–µ–Ω—ã

### 8. –û–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

- `docker-compose.yml` ‚Äî –Ω–æ–≤—ã–µ ENV –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
- `.env.example` ‚Äî –ø–æ–ª–Ω—ã–π –ø—Ä–∏–º–µ—Ä –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
- `DEVELOPER_GUIDE.md` ‚Äî –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏
- `bot/handlers/__init__.py` ‚Äî —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è admin_router

### 9. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ gpt-image-1.5 –¥–ª—è edit

**–§–∞–π–ª—ã:**
- `bot/services/image_provider.py` ‚Äî —É–±—Ä–∞–Ω fallback
- `bot/handlers/edit.py` ‚Äî —É–±—Ä–∞–Ω fallback

–¢–µ–ø–µ—Ä—å `gpt-image-1.5` –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (—Å–æ–≥–ª–∞—Å–Ω–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ OpenAI).

---

## –ö–∞–∫ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –∞–¥–º–∏–Ω–∫—É

1. –£–∑–Ω–∞–π —Å–≤–æ–π Telegram ID (–Ω–∞–ø–∏—à–∏ –±–æ—Ç—É @userinfobot)

2. –î–æ–±–∞–≤—å –≤ `.env`:
```env
ADMIN_IDS=—Ç–≤–æ–π_telegram_id
ADMIN_API_KEY=—Å–≥–µ–Ω–µ—Ä–∏—Ä—É–π_—Å–ª—É—á–∞–π–Ω—É—é_—Å—Ç—Ä–æ–∫—É
```

3. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏ –±–æ—Ç–∞:
```bash
docker-compose build --no-cache
docker-compose up -d
```

4. –ù–∞–ø–∏—à–∏ –±–æ—Ç—É `/admin`


---

## –î–∞—Ç–∞: 28 –¥–µ–∫–∞–±—Ä—è 2025

### 10. –£–¥–∞–ª—ë–Ω ID –∑–∞–¥–∞—á–∏ –∏–∑ —Å–æ–æ–±—â–µ–Ω–∏–π –æ–± —É—Å–ø–µ—Ö–µ

**–§–∞–π–ª—ã:**
- `bot/handlers/generate.py`
- `bot/handlers/edit.py`
- `bot/handlers/trends.py`

–£–±—Ä–∞–Ω–∞ —Å—Ç—Ä–æ–∫–∞ `üÜî ID –∑–∞–¥–∞—á–∏: <code>{task.id}</code>` –∏–∑ —Å–æ–æ–±—â–µ–Ω–∏–π –æ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–¥–∞—á–∏.

### 11. –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Ñ–æ—Ç–æ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (–¥–æ 10)

**–§–∞–π–ª—ã:**
- `bot/handlers/edit.py` ‚Äî —Å–±–æ—Ä –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Ñ–æ—Ç–æ, +10% –∑–∞ –∫–∞–∂–¥–æ–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ
- `bot/services/image_provider.py` ‚Äî –ø–æ–¥–¥–µ—Ä–∂–∫–∞ JSON-–º–∞—Å—Å–∏–≤–∞ file_id
- `bot/states/generation.py` ‚Äî –æ–±–Ω–æ–≤–ª–µ–Ω—ã –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏

–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –¥–æ 10 –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π. –ö–∞–∂–¥–æ–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ –¥–æ–±–∞–≤–ª—è–µ—Ç +10% –∫ —Å—Ç–æ–∏–º–æ—Å—Ç–∏.

### 12. –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ –æ—Ç–≤–µ—Ç –Ω–∞ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ

**–§–∞–π–ª:** `bot/handlers/edit.py`

–ù–æ–≤—ã–π —Ö–µ–Ω–¥–ª–µ—Ä `handle_reply_to_edit` ‚Äî –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ –±–æ—Ç–∞ —Å –¥–æ–∫—É–º–µ–Ω—Ç–æ–º (—Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –∫–∞—Ä—Ç–∏–Ω–∫–æ–π) —Ç–µ–∫—Å—Ç–æ–º, –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è flow —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.

### 13. –ú–µ–Ω—é –∫–æ–º–∞–Ω–¥ –±–æ—Ç–∞

**–§–∞–π–ª:** `bot/main.py`

–ü—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –±–æ—Ç–∞ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é—Ç—Å—è –∫–æ–º–∞–Ω–¥—ã —á–µ—Ä–µ–∑ `set_my_commands`:
- `/start` ‚Äî –ó–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞
- `/balance` ‚Äî –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –±–∞–ª–∞–Ω—Å
- `/guide` ‚Äî –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ
- `/support` ‚Äî –ü–æ–¥–¥–µ—Ä–∂–∫–∞
- `/invite` ‚Äî –ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å –¥—Ä—É–≥–∞

### 14. –£–ª—É—á—à–µ–Ω–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞

**–§–∞–π–ª:** `bot/tasks/generation.py`

- –ü—Ä–æ–º–ø—Ç –≤ `<blockquote>`
- –ò–º—è —Ñ–∞–π–ª–∞: `GPT_Image_{task_id}.png`
- –ü–æ–¥—Å–∫–∞–∑–∫–∞ –æ reply-to-edit
- –ö–Ω–æ–ø–∫–∞ ¬´–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –µ—â—ë¬ª

### 15. –ö–æ–º–∞–Ω–¥–∞ /support

**–ù–æ–≤—ã–π —Ñ–∞–π–ª:** `bot/handlers/support.py`

–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∫–æ–Ω—Ç–∞–∫—Ç –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –∏–∑ `SUPPORT_USERNAME`.

**–§–∞–π–ª:** `bot/config.py` ‚Äî –¥–æ–±–∞–≤–ª–µ–Ω–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è `support_username`

### 16. –ö–Ω–æ–ø–∫–∞ ¬´–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –µ—â—ë¬ª

**–§–∞–π–ª—ã:**
- `bot/keyboards/inline.py` ‚Äî `regenerate_keyboard()`, `REGENERATE_PREFIX`
- `bot/handlers/regenerate.py` ‚Äî –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏

–ü—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –∑–∞–≥—Ä—É–∂–∞–µ—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏—Å—Ö–æ–¥–Ω–æ–π –∑–∞–¥–∞—á–∏ –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —ç–∫—Ä–∞–Ω –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è.

### 17. –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞

**–§–∞–π–ª—ã:**
- `bot/db/models.py` ‚Äî –ø–æ–ª–µ `referrer_id` –≤ User
- `bot/db/repositories.py` ‚Äî `get_referral_stats()`, –æ–±–Ω–æ–≤–ª—ë–Ω `get_or_create()`
- `bot/handlers/start.py` ‚Äî –ø–∞—Ä—Å–∏–Ω–≥ `ref_USERID` –∏–∑ deep link
- `bot/handlers/invite.py` ‚Äî –∫–æ–º–∞–Ω–¥–∞ `/invite`
- `alembic/versions/d9e2f3a4b5c6_add_referrer_id_to_users.py` ‚Äî –º–∏–≥—Ä–∞—Ü–∏—è

–§–æ—Ä–º–∞—Ç —Å—Å—ã–ª–∫–∏: `https://t.me/bot_username?start=ref_USERID`

### 18. –ù–æ–≤—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

| –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è | –û–ø–∏—Å–∞–Ω–∏–µ |
|------------|----------|
| `SUPPORT_USERNAME` | Username –ø–æ–¥–¥–µ—Ä–∂–∫–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä @support) |

### 19. –û–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

- `bot/handlers/__init__.py` ‚Äî —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è support_router, invite_router, regenerate_router
- `.env.example` ‚Äî –¥–æ–±–∞–≤–ª–µ–Ω SUPPORT_USERNAME

---

## –ö–∞–∫ –ø—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é

```bash
# –õ–æ–∫–∞–ª—å–Ω–æ
alembic upgrade head

# –í Docker
docker-compose exec app alembic upgrade head
```
