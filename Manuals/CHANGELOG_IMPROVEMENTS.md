# Changelog: –£–ª—É—á—à–µ–Ω–∏—è –∏ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥

## –î–∞—Ç–∞: 26 –¥–µ–∫–∞–±—Ä—è 2025

### 1. –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–∞—Ü–∏—è –∫–æ–Ω—Å—Ç–∞–Ω—Ç –≤ config.py

**–ë—ã–ª–æ:** `HIGH_COST_THRESHOLD = 4000` –¥—É–±–ª–∏—Ä–æ–≤–∞–ª—Å—è –≤ 3 —Ñ–∞–π–ª–∞—Ö

**–°—Ç–∞–ª–æ:** –ï–¥–∏–Ω–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è `config.high_cost_threshold` –∏–∑ ENV

**–§–∞–π–ª—ã:**
- `bot/config.py` ‚Äî –¥–æ–±–∞–≤–ª–µ–Ω—ã –Ω–æ–≤—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
- `bot/handlers/generate.py` ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `config.high_cost_threshold`
- `bot/handlers/edit.py` ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `config.high_cost_threshold`
- `bot/handlers/trends.py` ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `config.high_cost_threshold`

### 2. –ù–æ–≤—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

| –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è | –û–ø–∏—Å–∞–Ω–∏–µ |
|------------|----------|
| `HIGH_COST_THRESHOLD` | –ü–æ—Ä–æ–≥ –¥–ª—è –¥–≤–æ–π–Ω–æ–≥–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è (default: 4000) |
| `MAX_TASKS_PER_USER_PER_HOUR` | Rate limiting (default: 20) |
| `ADMIN_IDS` | Telegram ID –∞–¥–º–∏–Ω–æ–≤ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é |
| `ADMIN_API_KEY` | API –∫–ª—é—á –¥–ª—è HTTP –∞–¥–º–∏–Ω-—ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤ |

### 3. –°–µ—Ä–≤–∏—Å —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–¥–∞—á (task_service.py)

**–ù–æ–≤—ã–π —Ñ–∞–π–ª:** `bot/services/task_service.py`

–¶–µ–Ω—Ç—Ä–∞–ª–∏–∑—É–µ—Ç –ª–æ–≥–∏–∫—É —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–¥–∞—á:
- –ü—Ä–æ–≤–µ—Ä–∫–∞ rate limiting
- –°–ø–∏—Å–∞–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤
- –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏ –≤ –ë–î
- –ü–æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤ –æ—á–µ—Ä–µ–¥—å RQ

### 4. –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ (StatsRepository)

**–§–∞–π–ª:** `bot/db/repositories.py`

–ù–æ–≤—ã–µ –º–µ—Ç–æ–¥—ã:
- `get_total_users()` ‚Äî –≤—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- `get_total_tasks()` ‚Äî –≤—Å–µ–≥–æ –∑–∞–¥–∞—á
- `get_tasks_by_status()` ‚Äî –∑–∞–¥–∞—á–∏ –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º
- `get_total_tokens_spent()` ‚Äî –ø–æ—Ç—Ä–∞—á–µ–Ω–æ —Ç–æ–∫–µ–Ω–æ–≤
- `get_tasks_today()` ‚Äî –∑–∞–¥–∞—á —Å–µ–≥–æ–¥–Ω—è
- `get_users_today()` ‚Äî –Ω–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å–µ–≥–æ–¥–Ω—è
- `get_active_users_today()` ‚Äî –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–µ–≥–æ–¥–Ω—è
- `get_top_users()` ‚Äî —Ç–æ–ø –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- `get_model_usage()` ‚Äî –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –º–æ–¥–µ–ª–µ–π
- `get_full_stats()` ‚Äî –ø–æ–ª–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞

### 5. Rate Limiting

**–§–∞–π–ª:** `bot/db/repositories.py`

–ù–æ–≤—ã–π –º–µ—Ç–æ–¥ `count_user_tasks_since(user_id, hours)` –¥–ª—è –ø–æ–¥—Å—á—ë—Ç–∞ –∑–∞–¥–∞—á –∑–∞ –ø–µ—Ä–∏–æ–¥.

### 6. –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å (Telegram)

**–ù–æ–≤—ã–π —Ñ–∞–π–ª:** `bot/handlers/admin.py`

–ö–æ–º–∞–Ω–¥—ã:
- `/admin` ‚Äî –º–µ–Ω—é —Å –∫–Ω–æ–ø–∫–∞–º–∏
- `/stats` ‚Äî —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
- `/addtokens <id> <amount>` ‚Äî –¥–æ–±–∞–≤–∏—Ç—å —Ç–æ–∫–µ–Ω—ã
- `/userinfo <id>` ‚Äî –∏–Ω—Ñ–æ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ

### 7. –ê–¥–º–∏–Ω API (HTTP)

**–§–∞–π–ª:** `bot/main.py`

–≠–Ω–¥–ø–æ–∏–Ω—Ç—ã (—Ç—Ä–µ–±—É—é—Ç `X-Admin-API-Key`):
- `GET /admin/stats` ‚Äî —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
- `GET /admin/queue` ‚Äî –æ—á–µ—Ä–µ–¥—å RQ
- `GET /admin/users/{telegram_id}` ‚Äî –∏–Ω—Ñ–æ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
- `POST /admin/users/{telegram_id}/tokens` ‚Äî –¥–æ–±–∞–≤–∏—Ç—å —Ç–æ–∫–µ–Ω—ã

### 8. –û–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

- `docker-compose.yml` ‚Äî –Ω–æ–≤—ã–µ ENV –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
- `.env.example` ‚Äî –ø–æ–ª–Ω—ã–π –ø—Ä–∏–º–µ—Ä –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
- `DEVELOPER_GUIDE.md` ‚Äî –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏
- `bot/handlers/__init__.py` ‚Äî —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è admin_router

### 9. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ gpt-image-1.5 –¥–ª—è edit

**–§–∞–π–ª—ã:**
- `bot/services/image_provider.py` ‚Äî —É–±—Ä–∞–Ω fallback
- `bot/handlers/edit.py` ‚Äî —É–±—Ä–∞–Ω fallback

–¢–µ–ø–µ—Ä—å `gpt-image-1.5` –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (—Å–æ–≥–ª–∞—Å–Ω–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ OpenAI).

---

## –ö–∞–∫ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –∞–¥–º–∏–Ω–∫—É

1. –£–∑–Ω–∞–π —Å–≤–æ–π Telegram ID (–Ω–∞–ø–∏—à–∏ –±–æ—Ç—É @userinfobot)

2. –î–æ–±–∞–≤—å –≤ `.env`:
```env
ADMIN_IDS=—Ç–≤–æ–π_telegram_id
ADMIN_API_KEY=—Å–≥–µ–Ω–µ—Ä–∏—Ä—É–π_—Å–ª—É—á–∞–π–Ω—É—é_—Å—Ç—Ä–æ–∫—É
```

3. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏ –±–æ—Ç–∞:
```bash
docker-compose build --no-cache
docker-compose up -d
```

4. –ù–∞–ø–∏—à–∏ –±–æ—Ç—É `/admin`


---

## –î–∞—Ç–∞: 28 –¥–µ–∫–∞–±—Ä—è 2025

### 10. –£–¥–∞–ª—ë–Ω ID –∑–∞–¥–∞—á–∏ –∏–∑ —Å–æ–æ–±—â–µ–Ω–∏–π –æ–± —É—Å–ø–µ—Ö–µ

**–§–∞–π–ª—ã:**
- `bot/handlers/generate.py`
- `bot/handlers/edit.py`
- `bot/handlers/trends.py`

–£–±—Ä–∞–Ω–∞ —Å—Ç—Ä–æ–∫–∞ `üÜî ID –∑–∞–¥–∞—á–∏: <code>{task.id}</code>` –∏–∑ —Å–æ–æ–±—â–µ–Ω–∏–π –æ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–¥–∞—á–∏.

### 11. –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Ñ–æ—Ç–æ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (–¥–æ 10)

**–§–∞–π–ª—ã:**
- `bot/handlers/edit.py` ‚Äî —Å–±–æ—Ä –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Ñ–æ—Ç–æ, +10% –∑–∞ –∫–∞–∂–¥–æ–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ
- `bot/services/image_provider.py` ‚Äî –ø–æ–¥–¥–µ—Ä–∂–∫–∞ JSON-–º–∞—Å—Å–∏–≤–∞ file_id
- `bot/states/generation.py` ‚Äî –æ–±–Ω–æ–≤–ª–µ–Ω—ã –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏

–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –¥–æ 10 –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π. –ö–∞–∂–¥–æ–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ –¥–æ–±–∞–≤–ª—è–µ—Ç +10% –∫ —Å—Ç–æ–∏–º–æ—Å—Ç–∏.

### 12. –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ –æ—Ç–≤–µ—Ç –Ω–∞ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ

**–§–∞–π–ª:** `bot/handlers/edit.py`

–ù–æ–≤—ã–π —Ö–µ–Ω–¥–ª–µ—Ä `handle_reply_to_edit` ‚Äî –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ –±–æ—Ç–∞ —Å –¥–æ–∫—É–º–µ–Ω—Ç–æ–º (—Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –∫–∞—Ä—Ç–∏–Ω–∫–æ–π) —Ç–µ–∫—Å—Ç–æ–º, –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è flow —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.

### 13. –ú–µ–Ω—é –∫–æ–º–∞–Ω–¥ –±–æ—Ç–∞

**–§–∞–π–ª:** `bot/main.py`

–ü—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –±–æ—Ç–∞ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é—Ç—Å—è –∫–æ–º–∞–Ω–¥—ã —á–µ—Ä–µ–∑ `set_my_commands`:
- `/start` ‚Äî –ó–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞
- `/balance` ‚Äî –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –±–∞–ª–∞–Ω—Å
- `/guide` ‚Äî –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ
- `/support` ‚Äî –ü–æ–¥–¥–µ—Ä–∂–∫–∞
- `/invite` ‚Äî –ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å –¥—Ä—É–≥–∞

### 14. –£–ª—É—á—à–µ–Ω–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞

**–§–∞–π–ª:** `bot/tasks/generation.py`

- –ü—Ä–æ–º–ø—Ç –≤ `<blockquote>`
- –ò–º—è —Ñ–∞–π–ª–∞: `GPT_Image_{task_id}.png`
- –ü–æ–¥—Å–∫–∞–∑–∫–∞ –æ reply-to-edit
- –ö–Ω–æ–ø–∫–∞ ¬´–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –µ—â—ë¬ª

### 15. –ö–æ–º–∞–Ω–¥–∞ /support

**–ù–æ–≤—ã–π —Ñ–∞–π–ª:** `bot/handlers/support.py`

–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∫–æ–Ω—Ç–∞–∫—Ç –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –∏–∑ `SUPPORT_USERNAME`.

**–§–∞–π–ª:** `bot/config.py` ‚Äî –¥–æ–±–∞–≤–ª–µ–Ω–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è `support_username`

### 16. –ö–Ω–æ–ø–∫–∞ ¬´–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –µ—â—ë¬ª

**–§–∞–π–ª—ã:**
- `bot/keyboards/inline.py` ‚Äî `regenerate_keyboard()`, `REGENERATE_PREFIX`
- `bot/handlers/regenerate.py` ‚Äî –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏

–ü—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –∑–∞–≥—Ä—É–∂–∞–µ—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏—Å—Ö–æ–¥–Ω–æ–π –∑–∞–¥–∞—á–∏ –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —ç–∫—Ä–∞–Ω –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è.

### 17. –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞

**–§–∞–π–ª—ã:**
- `bot/db/models.py` ‚Äî –ø–æ–ª–µ `referrer_id` –≤ User
- `bot/db/repositories.py` ‚Äî `get_referral_stats()`, –æ–±–Ω–æ–≤–ª—ë–Ω `get_or_create()`
- `bot/handlers/start.py` ‚Äî –ø–∞—Ä—Å–∏–Ω–≥ `ref_USERID` –∏–∑ deep link
- `bot/handlers/invite.py` ‚Äî –∫–æ–º–∞–Ω–¥–∞ `/invite`
- `alembic/versions/d9e2f3a4b5c6_add_referrer_id_to_users.py` ‚Äî –º–∏–≥—Ä–∞—Ü–∏—è

–§–æ—Ä–º–∞—Ç —Å—Å—ã–ª–∫–∏: `https://t.me/bot_username?start=ref_USERID`

### 18. –ù–æ–≤—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

| –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è | –û–ø–∏—Å–∞–Ω–∏–µ |
|------------|----------|
| `SUPPORT_USERNAME` | Username –ø–æ–¥–¥–µ—Ä–∂–∫–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä @support) |

### 19. –û–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

- `bot/handlers/__init__.py` ‚Äî —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è support_router, invite_router, regenerate_router
- `.env.example` ‚Äî –¥–æ–±–∞–≤–ª–µ–Ω SUPPORT_USERNAME

---

## –ö–∞–∫ –ø—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é

```bash
# –õ–æ–∫–∞–ª—å–Ω–æ
alembic upgrade head

# –í Docker
docker-compose exec app alembic upgrade head
```
