# ReadMeUpdatesGPT.md

Этот документ — сводка изменений, которые были внесены мной в проект **NanoBananaTgBot** в ходе нашей совместной работы, а также пояснение **зачем** эти изменения были сделаны и какие улучшения они дают.

## 1) Новая система стоимости генерации (Image Tokens)

### Что сделано
- Добавлен модуль `bot/services/image_tokens.py`.
- Введены понятия:
  - `image_quality`: `low | medium | high`
  - `image_size`: `1024x1024 | 1024x1536 | 1536x1024`
- Реализована таблица стоимостей и функции:
  - валидации параметров
  - получения человекочитаемых лейблов
  - расчёта стоимости `estimate_image_tokens(quality, size)`

### Почему
- Раньше стоимость была фиксированной и не отражала реальную «цену» разных режимов качества/форматов.
- Требовалось показать пользователю стоимость **до** запуска задачи и дать возможность выбрать настройки.

### Что улучшило
- Динамический расчёт стоимости.
- Единый источник истины для всей логики расчётов (handlers/worker/tests).


## 2) Расширение модели данных (SQLAlchemy) и миграции Alembic

### Что сделано
- Обновлён `bot/db/models.py`:
  - у `User` добавлены `image_quality`, `image_size`.
  - у `GenerationTask` добавлены `model`, `image_quality`, `image_size`, `result_file_id`.
- Добавлена миграция:
  - `alembic/versions/c8f1a2d3e4f5_add_image_params_and_result_file_id.py`
  - миграция добавляет новые колонки и **масштабирует токены** для обратной совместимости.

### Почему
- Нужно хранить выбор пользователя (качество/формат), чтобы:
  - показывать его в профиле,
  - применять по умолчанию,
  - использовать в задачах.
- Нужно хранить `result_file_id`, чтобы отдавать изображения из истории без повторной загрузки/перегенерации.

### Что улучшило
- Стабильная история (через `file_id`).
- Настройки сохраняются в БД и переиспользуются.
- Обратная совместимость за счёт перерасчёта балансов.


## 3) Репозитории БД: поддержка новых полей и «масштабирование» токенов

### Что сделано
- Обновлён `bot/db/repositories.py`:
  - расширены методы создания/обновления пользователя и задач с учётом `image_quality`, `image_size`, `model`.
  - добавлена логика масштабирования стартового баланса под систему image-tokens.

### Почему
- Слой репозиториев является точкой, где удобно обеспечивать консистентность данных.

### Что улучшило
- Единый способ создавать задачи с корректными параметрами.
- Меньше дублирования кода в хендлерах.


## 4) Инлайн-клавиатуры: выбор качества/формата + подтверждения

### Что сделано
- Обновлён `bot/keyboards/inline.py`:
  - добавлены callback-prefix’ы для качества и формата;
  - добавлена клавиатура выбора `quality/size`;
  - добавлены подтверждения (confirm/cancel) и второй шаг подтверждения для дорогих операций.
- Обновлён `bot/keyboards/__init__.py` для экспорта новых клавиатур.

### Почему
- Требовался удобный UI без ручного ввода параметров.
- Нужно подтверждение перед списанием токенов.

### Что улучшило
- UX (быстрее/понятнее).
- Меньше ошибок ввода.


## 5) Генерация изображений (`bot/handlers/generate.py`)

### Что сделано
- Переписан flow генерации:
  - стоимость показывается до запуска;
  - пользователь выбирает `quality/size` на экране подтверждения;
  - стоимость считается через `estimate_image_tokens`;
  - добавлено двухшаговое подтверждение для дорогих генераций (`HIGH_COST_THRESHOLD = 4000`).
- Исправлена логика так, чтобы **первый шаг** (дорогая операция) происходил именно внутри callback подтверждения, а не в обработчике текста.

### Почему
- Нужно было исключить списание/создание задач без явного подтверждения.
- Дорогие операции должны требовать дополнительного подтверждения.

### Что улучшило
- Безопасность списания токенов.
- Предсказуемость flow FSM.


## 6) Редактирование изображений (`bot/handlers/edit.py`)

### Что сделано
- Аналогично генерации:
  - добавлены `quality/size` в процесс редактирования;
  - стоимость отображается до выполнения;
  - реализовано двухшаговое подтверждение при дорогих операциях.
- Исправлен баг: ранее в одном месте использовался `callback` внутри `process_edit_prompt` (где его нет), что приводило бы к runtime-ошибке.

### Почему
- Редактирование тоже потребляет токены и требует тех же UX/гарантий.

### Что улучшило
- Устойчивость обработчиков.
- Единообразие поведения с генерацией.


## 7) Шаблоны/Trends (`bot/handlers/trends.py`)

### Что сделано
- Обновлён flow шаблонов под новую систему стоимости:
  - динамическая стоимость: `estimate_image_tokens(quality, size)` + `template.tokens_cost`;
  - двухшаговое подтверждение для дорогих шаблонов;
  - сохранение выбранных параметров.

### Почему
- Шаблоны должны быть совместимы с общей системой image-tokens.

### Что улучшило
- Консистентность стоимости.
- Контроль дорогих запусков.


## 8) Профиль и история (`bot/handlers/profile.py`)

### Что сделано
- История теперь работает через Telegram `file_id`:
  - при наличии `result_file_id` бот отправляет документ повторно без повторной загрузки/генерации.
- Улучшена навигация по истории через inline-кнопки.

### Почему
- Ссылки/URL могут устаревать, а `file_id` — нативный механизм Telegram.

### Что улучшило
- Скорость показа истории.
- Меньше сетевых ошибок.


## 9) Баланс и быстрые настройки (`/balance`, `/tokens`)

### Что сделано
- Добавлен новый handler `bot/handlers/balance.py`:
  - команды `/balance` и алиас `/tokens` показывают баланс + текущие настройки.
- Подключен router в `bot/handlers/__init__.py`.

### Почему
- Пользователю нужно быстро видеть баланс и актуальные параметры генерации.

### Что улучшило
- UX и прозрачность расхода токенов.


## 10) Worker: генерация/редактирование, отправка как document, сохранение `file_id`

### Что сделано
- Обновлён worker `bot/tasks/generation.py`:
  - учитывает `model`, `image_quality`, `image_size` из `GenerationTask`;
  - отправляет результат как **Telegram document**;
  - сохраняет `result_file_id`;
  - улучшена обработка ошибок и статусы задач.

### Почему
- Отправка как `document` сохраняет качество и удобнее для пользователя.
- `file_id` нужен для истории.

### Что улучшило
- Качество доставки результата.
- История становится стабильной.


## 11) Конфиги/production: устойчивый startup, webhook retry, secret token, Redis FSM

### Что сделано
- Обновлён `bot/main.py`:
  - `set_webhook()` больше не валит приложение при таймауте;
  - добавлены retry/backoff;
  - добавлена проверка `WEBHOOK_SECRET_TOKEN` в endpoint `/webhook`.
- Обновлён `bot/config.py`:
  - добавлены переменные окружения для таймаутов/ретраев/логов;
  - добавлен переключатель `USE_REDIS_FSM_STORAGE`.
- Обновлён `bot/bot.py`:
  - опционально используется `RedisStorage` для FSM.
- Обновлён `worker.py`:
  - поддержка `LOG_LEVEL`.
- Обновлены `docker-compose.yml` и `docker-compose.dev.yml`:
  - добавлены новые ENV для `app` и `worker`.

### Почему
- На сервере было падение приложения на старте из‑за `set_webhook()` timeout.
- В проде webhook endpoint должен быть защищён.
- FSM на MemoryStorage не подходит для рестартов/масштабирования.

### Что улучшило
- Устойчивость запуска.
- Безопасность webhook.
- Production‑готовность FSM.


## 12) Обновления текстов/гайда

### Что сделано
- Обновлены `bot/handlers/guide.py` и `bot/utils/messages.py`:
  - убрано устаревшее описание «1 токен за генерацию»;
  - добавлено описание выбора качества/формата;
  - исправлена нумерация шагов.
- Обновлён текст «Купить токены» (примерные пакеты приведены к масштабу image-tokens).

### Почему
- После внедрения image-tokens старые тексты вводили бы пользователя в заблуждение.

### Что улучшило
- Соответствие UI и фактической логики.


## 13) Тесты

### Что сделано
- Обновлены тесты (`tests/test_db.py`, `tests/test_services.py`) под новую модель и новые правила токенов.
- Прогон `pytest` после правок проходит успешно.

### Почему
- Изменились инварианты по балансу и стоимости.

### Что улучшило
- Регрессии ловятся тестами.


## Итог

В результате проект получил:
- современную систему стоимости (image tokens) с выбором параметров,
- безопасный UX подтверждений (включая двойное подтверждение для дорогих операций),
- отправку результата как document и устойчивую историю через `file_id`,
- команду проверки баланса,
- улучшенную production-устойчивость (webhook retry, не падающий startup, secret token, Redis FSM),
- обновлённые тексты и тесты.
