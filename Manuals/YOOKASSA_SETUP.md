# Настройка ЮKassa для приёма платежей 💳

## Шаг 1: Получение API ключей

1. Войдите в [личный кабинет ЮKassa](https://yookassa.ru/my)
2. Перейдите в **Интеграция** → **Ключи API**
3. Скопируйте:
   - **shopId** (идентификатор магазина)
   - **Секретный ключ** (нажмите "Показать" и скопируйте)

## Шаг 2: Настройка .env

Добавьте в файл `.env` на сервере:

```env
# YooKassa Payment Integration
YOOKASSA_SHOP_ID=123456
YOOKASSA_SECRET_KEY=test_XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
YOOKASSA_RETURN_URL=https://t.me/your_bot_username
```

**Важно:**
- `YOOKASSA_RETURN_URL` — это ссылка на вашего бота, куда пользователь вернётся после оплаты
- Для тестового магазина ключ начинается с `test_`
- Для боевого магазина ключ начинается с `live_`

## Шаг 3: Настройка Webhook в ЮKassa

1. В личном кабинете перейдите в **Интеграция** → **HTTP-уведомления**
2. Нажмите **Добавить URL**
3. Укажите URL: `https://your-domain.com/yookassa/webhook`
4. Выберите события:
   - ✅ `payment.succeeded` — платёж успешен
   - ✅ `payment.canceled` — платёж отменён
   - ⬜ `payment.waiting_for_capture` — опционально
5. Нажмите **Сохранить**

## Шаг 4: Применение миграции

```bash
# В Docker
docker-compose exec app alembic upgrade head

# Или при перезапуске (автоматически)
docker-compose restart app
```

## Шаг 5: Перезапуск бота

```bash
# Быстрый деплой
./deploy.sh

# Или вручную
docker-compose restart app worker
```

## Шаг 6: Тестирование

### Тестовый режим

Для тестового магазина используйте тестовые карты:
- **Успешная оплата:** `5555 5555 5555 4444`
- **Отклонённая оплата:** `5555 5555 5555 4477`
- CVC: любые 3 цифры
- Срок: любая дата в будущем

### Проверка работы

1. Откройте бота
2. Нажмите **💰 Купить токены**
3. Выберите любой пакет
4. Нажмите **💳 Оплатить**
5. Оплатите тестовой картой
6. Вернитесь в бота — токены должны зачислиться автоматически

## Как это работает

```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│   Telegram  │────▶│    Бот      │────▶│   YooKassa  │
│   Клиент    │     │   (FastAPI) │     │     API     │
└─────────────┘     └─────────────┘     └─────────────┘
       │                   │                   │
       │  1. Выбор пакета  │                   │
       │──────────────────▶│                   │
       │                   │  2. Создание      │
       │                   │     платежа       │
       │                   │──────────────────▶│
       │                   │                   │
       │                   │  3. URL оплаты    │
       │                   │◀──────────────────│
       │  4. Ссылка на     │                   │
       │     оплату        │                   │
       │◀──────────────────│                   │
       │                   │                   │
       │  5. Оплата        │                   │
       │──────────────────────────────────────▶│
       │                   │                   │
       │                   │  6. Webhook       │
       │                   │◀──────────────────│
       │                   │                   │
       │  7. Уведомление   │                   │
       │     + токены      │                   │
       │◀──────────────────│                   │
       │                   │                   │
```

## Troubleshooting

### Платёж создаётся, но токены не зачисляются

1. Проверьте, что webhook настроен правильно в ЮKassa
2. Проверьте логи: `make logs`
3. Убедитесь, что URL webhook доступен извне

### Ошибка "YooKassa not configured"

Проверьте, что переменные `YOOKASSA_SHOP_ID` и `YOOKASSA_SECRET_KEY` заданы в `.env` и переданы в Docker.

### Webhook не приходит

1. Проверьте, что ваш сервер доступен по HTTPS
2. Проверьте настройки webhook в личном кабинете ЮKassa
3. Попробуйте отправить тестовый webhook из ЛК ЮKassa

### Ошибка при создании платежа

Проверьте логи:
```bash
make logs | grep -i yookassa
```

## Безопасность

- Секретный ключ храните только в `.env`, не коммитьте в git
- Webhook endpoint не требует авторизации (ЮKassa не поддерживает)
- Все платежи логируются в базу данных
- Админы получают уведомления о каждой оплате

## Пакеты и цены

| Пакет | Цена | Токены | Скидка |
|-------|------|--------|--------|
| 🐣 Starter | 99 ₽ | 10 | — |
| ✨ Small | 249 ₽ | 50 | 50% |
| 🔥 Medium | 449 ₽ | 120 | 62% |
| 😎 Pro | 890 ₽ | 300 | 70% |
| 👑 Vip | 1690 ₽ | 700 | 75% |

Цены настраиваются в `bot/keyboards/inline.py` → `SHOP_PACKAGES`.
