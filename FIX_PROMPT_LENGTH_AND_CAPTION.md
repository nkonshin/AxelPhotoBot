# –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—à–∏–±–æ–∫ —Å –¥–ª–∏–Ω–æ–π –ø—Ä–æ–º–ø—Ç–∞

## –ü—Ä–æ–±–ª–µ–º–∞ 1: "message caption is too long"
–ü—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –≤–æ–∑–Ω–∏–∫–∞–ª–∞ –æ—à–∏–±–∫–∞:
```
Bad Request: message caption is too long
```

Telegram –∏–º–µ–µ—Ç –∂–µ—Å—Ç–∫–∏–π –ª–∏–º–∏—Ç –≤ **1024 —Å–∏–º–≤–æ–ª–∞** –¥–ª—è caption —Å–æ–æ–±—â–µ–Ω–∏—è.

### –ü—Ä–∏—á–∏–Ω–∞
–†–∞–Ω—å—à–µ –º—ã –ø—Ä–æ—Å—Ç–æ –æ–±—Ä–µ–∑–∞–ª–∏ –ø—Ä–æ–º–ø—Ç –¥–æ 700 —Å–∏–º–≤–æ–ª–æ–≤, –Ω–æ –Ω–µ —É—á–∏—Ç—ã–≤–∞–ª–∏:
- HTML —Ç–µ–≥–∏ (`<b>`, `<i>`, `<blockquote expandable>`)
- –û—Å—Ç–∞–ª—å–Ω–æ–π —Ç–µ–∫—Å—Ç (tips, –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –º–æ–¥–µ–ª–∏, —Ç–æ–∫–µ–Ω–∞—Ö –∏ —Ç.–¥.)
- –û–±—â–∞—è –¥–ª–∏–Ω–∞ caption –º–æ–≥–ª–∞ –ø—Ä–µ–≤—ã—à–∞—Ç—å 1024 —Å–∏–º–≤–æ–ª–∞

## –ü—Ä–æ–±–ª–µ–º–∞ 2: "value too long for type character varying(2000)"
–ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–¥–∞—á–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –≤–æ–∑–Ω–∏–∫–∞–ª–∞ –æ—à–∏–±–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö:
```
asyncpg.exceptions.StringDataRightTruncationError: value too long for type character varying(2000)
```

### –ü—Ä–∏—á–∏–Ω–∞
- –í handlers –≤–∞–ª–∏–¥–∞—Ü–∏—è –±—ã–ª–∞ –Ω–∞ 3000 —Å–∏–º–≤–æ–ª–æ–≤
- –í –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª–µ `prompt` –±—ã–ª–æ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–æ 2000 —Å–∏–º–≤–æ–ª–∞–º–∏
- –ù–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –º–µ–∂–¥—É –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π –≤ –∫–æ–¥–µ –∏ —Å—Ö–µ–º–æ–π –ë–î
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ç–µ—Ä—è–ª —Ç–æ–∫–µ–Ω—ã, –Ω–æ –∑–∞–¥–∞—á–∞ –Ω–µ —Å–æ–∑–¥–∞–≤–∞–ª–∞—Å—å

## –†–µ—à–µ–Ω–∏–µ

### 1. –£–≤–µ–ª–∏—á–µ–Ω –ª–∏–º–∏—Ç –ø—Ä–æ–º–ø—Ç–∞ –¥–æ 3500 —Å–∏–º–≤–æ–ª–æ–≤
**–í–∞–ª–∏–¥–∞—Ü–∏—è –≤ handlers:**
- `bot/handlers/generate.py` - –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
- `bot/handlers/edit.py` - –¥–≤–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏

**–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö:**
- `bot/db/models.py` - –º–æ–¥–µ–ª—å GenerationTask, –ø–æ–ª–µ `prompt` –∏–∑–º–µ–Ω–µ–Ω–æ —Å `String(2000)` –Ω–∞ `String(3500)`
- `alembic/versions/20260125_increase_prompt_length.py` - –º–∏–≥—Ä–∞—Ü–∏—è –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ö–µ–º—ã –ë–î

### 2. –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π —Ä–∞—Å—á–µ—Ç –¥–ª–∏–Ω—ã –ø—Ä–æ–º–ø—Ç–∞ –≤ caption
–¢–µ–ø–µ—Ä—å –º—ã:
1. –°–Ω–∞—á–∞–ª–∞ —Å—Ç—Ä–æ–∏–º –≤–µ—Å—å —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π —Ç–µ–∫—Å—Ç —Å placeholder –¥–ª—è –ø—Ä–æ–º–ø—Ç–∞
2. –í—ã—á–∏—Å–ª—è–µ–º, —Å–∫–æ–ª—å–∫–æ –º–µ—Å—Ç–∞ –æ—Å—Ç–∞–ª–æ—Å—å –¥–ª—è –ø—Ä–æ–º–ø—Ç–∞: `1000 - –¥–ª–∏–Ω–∞_—Å—Ç–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ_—Ç–µ–∫—Å—Ç–∞`
3. –û–±—Ä–µ–∑–∞–µ–º –ø—Ä–æ–º–ø—Ç –¥–æ —ç—Ç–æ–π –¥–ª–∏–Ω—ã
4. –ó–∞–º–µ–Ω—è–µ–º placeholder –Ω–∞ –æ–±—Ä–µ–∑–∞–Ω–Ω—ã–π –ø—Ä–æ–º–ø—Ç

```python
# –°—Ç—Ä–æ–∏–º —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π —Ç–µ–∫—Å—Ç —Å placeholder
static_text = (
    f"{task_type_emoji} <b>{task_type_text}!</b>\n\n"
    f"<blockquote expandable>PROMPT_PLACEHOLDER</blockquote>\n\n"
    # ... –æ—Å—Ç–∞–ª—å–Ω–æ–π —Ç–µ–∫—Å—Ç
)

# –í—ã—á–∏—Å–ª—è–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω—É—é –¥–ª–∏–Ω—É –ø—Ä–æ–º–ø—Ç–∞
telegram_limit = 1000  # –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π –∑–∞–ø–∞—Å –Ω–∏–∂–µ 1024
static_length = len(static_text) - len("PROMPT_PLACEHOLDER")
max_prompt_length = telegram_limit - static_length

# –û–±—Ä–µ–∑–∞–µ–º –ø—Ä–æ–º–ø—Ç
prompt_text = task.prompt[:max_prompt_length] + "..." if len(task.prompt) > max_prompt_length else task.prompt

# –ó–∞–º–µ–Ω—è–µ–º placeholder
caption = static_text.replace("PROMPT_PLACEHOLDER", prompt_text)
```

### 3. Fallback –º–µ—Ö–∞–Ω–∏–∑–º –¥–ª—è caption
–î–æ–±–∞–≤–ª–µ–Ω try-catch —Å –¥–≤—É–º—è –ø–æ–ø—ã—Ç–∫–∞–º–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏:

**–ü–æ–ø—ã—Ç–∫–∞ 1**: –û—Ç–ø—Ä–∞–≤–∫–∞ —Å –ø–æ–ª–Ω—ã–º caption (–≤–∫–ª—é—á–∞—è tips)
**–ü–æ–ø—ã—Ç–∫–∞ 2** (–µ—Å–ª–∏ caption –≤—Å–µ –µ—â–µ —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω—ã–π): –û—Ç–ø—Ä–∞–≤–∫–∞ —Å –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–º caption –±–µ–∑ tips

```python
for attempt in range(2):
    try:
        # –û—Ç–ø—Ä–∞–≤–∫–∞ —Å caption_to_use
        sent = await bot.send_document(...)
        break  # –£—Å–ø–µ—Ö
    except Exception as e:
        if "caption is too long" in str(e).lower() and attempt == 0:
            # –°–æ–∑–¥–∞–µ–º –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π caption –±–µ–∑ tips
            caption_to_use = (
                f"{task_type_emoji} <b>{task_type_text}!</b>\n\n"
                f"<blockquote expandable>{minimal_prompt}</blockquote>\n\n"
                f"‚öôÔ∏è –ö–∞—á–µ—Å—Ç–≤–æ: {quality_label}\n"
                f"üí∞ –°–ø–∏—Å–∞–Ω–æ: {task.tokens_spent} ü™ô\n\n"
                f"–°–¥–µ–ª–∞–Ω–æ –≤ @AxelPhotobot"
            )
            continue  # –ü–æ–≤—Ç–æ—Ä–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞
        else:
            raise  # –î—Ä—É–≥–∞—è –æ—à–∏–±–∫–∞ –∏–ª–∏ –≤—Ç–æ—Ä–∞—è –ø–æ–ø—ã—Ç–∫–∞
```

## –†–µ–∑—É–ª—å—Ç–∞—Ç
- ‚úÖ –£–≤–µ–ª–∏—á–µ–Ω –ª–∏–º–∏—Ç –ø—Ä–æ–º–ø—Ç–∞ —Å 3000 –¥–æ 3500 —Å–∏–º–≤–æ–ª–æ–≤ (–≤–∞–ª–∏–¥–∞—Ü–∏—è + –ë–î)
- ‚úÖ Caption –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –ø—Ä–µ–≤—ã—Å–∏—Ç –ª–∏–º–∏—Ç Telegram
- ‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å –¥–ª–∏–Ω–Ω—ã–º–∏ –ø—Ä–æ–º–ø—Ç–∞–º–∏ (–¥–æ 3500 —Å–∏–º–≤–æ–ª–æ–≤) –ø–æ–ª—É—á–∞—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç
- ‚úÖ –í —Å–ª—É—á–∞–µ –æ—á–µ–Ω—å –¥–ª–∏–Ω–Ω–æ–≥–æ –ø—Ä–æ–º–ø—Ç–∞ –±—É–¥–µ—Ç –ø–æ–∫–∞–∑–∞–Ω–∞ –º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è caption
- ‚úÖ –ù–µ—Ç –ø–æ—Ç–µ—Ä–∏ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –∏–∑-–∑–∞ –æ—à–∏–±–∫–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏
- ‚úÖ –ù–µ—Ç –ø–æ—Ç–µ—Ä–∏ —Ç–æ–∫–µ–Ω–æ–≤ –∏–∑-–∑–∞ –æ—à–∏–±–∫–∏ –ë–î

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
1. –û—Ç–ø—Ä–∞–≤—å—Ç–µ –ø—Ä–æ–º–ø—Ç –¥–ª–∏–Ω–æ–π 3500 —Å–∏–º–≤–æ–ª–æ–≤
2. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –∑–∞–¥–∞—á–∞ —Å–æ–∑–¥–∞–µ—Ç—Å—è –≤ –ë–î
3. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω
4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ caption –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ–±—Ä–µ–∑–∞–Ω

## –î–µ–ø–ª–æ–π

### –õ–æ–∫–∞–ª—å–Ω–æ
```bash
git add bot/tasks/generation.py bot/handlers/generate.py bot/handlers/edit.py bot/db/models.py alembic/versions/20260125_increase_prompt_length.py FIX_PROMPT_LENGTH_AND_CAPTION.md
git commit -m "fix: increase prompt limit to 3500 chars (handlers + DB) and dynamic caption length"
git push
```

### –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ
```bash
cd ~/NanoBananaBot
git pull

# –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é –ë–î
docker-compose exec telegram_bot_app alembic upgrade head

# –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Ä–≤–∏—Å—ã
./deploy.sh
```

## –í–∞–∂–Ω–æ!
–ü–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –º–∏–≥—Ä–∞—Ü–∏–∏ –ø–æ–ª–µ `prompt` –≤ —Ç–∞–±–ª–∏—Ü–µ `generation_tasks` –±—É–¥–µ—Ç –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å –¥–æ 3500 —Å–∏–º–≤–æ–ª–æ–≤. –≠—Ç–æ —Ä–µ—à–∏—Ç –ø—Ä–æ–±–ª–µ–º—É —Å –ø–æ—Ç–µ—Ä–µ–π —Ç–æ–∫–µ–Ω–æ–≤ –ø—Ä–∏ –¥–ª–∏–Ω–Ω—ã—Ö –ø—Ä–æ–º–ø—Ç–∞—Ö.
